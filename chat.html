<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #f6f9fc;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e6ecf0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0,0,0,0.02);
        }
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #eef2f6;
        }
        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #0a2540;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-header h2 span {
            background: #007bff;
            color: white;
            font-size: 14px;
            padding: 2px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .user-item:hover {
            background: #f0f7ff;
            border-color: #cce5ff;
        }
        .user-item.active {
            background: #e6f2ff;
            border-color: #007bff;
        }
        .user-avatar {
            width: 48px;
            height: 48px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }
        .user-info {
            flex: 1;
            min-width: 0;
        }
        .user-name {
            font-weight: 600;
            color: #0a2540;
            display: flex;
            justify-content: space-between;
        }
        .user-name span {
            font-size: 13px;
            color: #6c7a89;
            font-weight: normal;
        }
        .user-preview {
            font-size: 13px;
            color: #5f6c80;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }
        .badge {
            background: #007bff;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .chat-header {
            padding: 24px 30px;
            border-bottom: 1px solid #eef2f6;
            background: white;
        }
        .chat-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #0a2540;
        }
        .chat-header p {
            color: #5f6c80;
            font-size: 14px;
            margin-top: 4px;
        }
        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #fafcfe;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        .message.user {
            align-self: flex-end;
        }
        .message.employee {
            align-self: flex-start;
        }
        .message-content {
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 6px;
        }
        .message.employee .message-content {
            background: #f0f2f6;
            color: #0a2540;
            border-bottom-left-radius: 6px;
        }
        .message-time {
            font-size: 11px;
            color: #8c9aa8;
            margin-top: 6px;
            margin-left: 8px;
        }
        .no-chat-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8c9aa8;
            font-size: 16px;
            flex-direction: column;
            gap: 12px;
        }
        .reply-area {
            padding: 24px 30px;
            border-top: 1px solid #eef2f6;
            background: white;
        }
        .reply-box {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        textarea {
            flex: 1;
            border: 1px solid #d0d9e4;
            border-radius: 24px;
            padding: 14px 18px;
            font-size: 15px;
            resize: none;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
            background: white;
        }
        textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        .send-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .send-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        .send-btn svg {
            width: 20px;
            height: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c7a89;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>
                ðŸ’¬ Active Chats
                <span id="userCount">0</span>
            </h2>
        </div>
        <div class="user-list" id="userList">
            <!-- Users will appear here -->
            <div class="empty-state">No active conversations yet.</div>
        </div>
    </div>

    <div class="chat-area" id="chatArea">
        <div class="no-chat-selected">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#8c9aa8" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <p>Select a user to start chatting</p>
        </div>
    </div>

    <script>
        // In a real implementation, this would connect to a backend.
        // For demo, we use localStorage to simulate real-time communication between user and admin.
        
        let currentUserId = null;
        let users = {};
        let messages = {};

        // Load data from localStorage
        function loadData() {
            const stored = localStorage.getItem('chat_system_messages');
            if (stored) {
                messages = JSON.parse(stored);
            }
            // Rebuild user list from messages
            rebuildUsers();
            renderUserList();
            if (currentUserId && users[currentUserId]) {
                openChat(currentUserId);
            } else {
                document.getElementById('chatArea').innerHTML = `<div class="no-chat-selected">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#8c9aa8" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    <p>Select a user to start chatting</p>
                </div>`;
            }
        }

        function rebuildUsers() {
            users = {};
            for (let userId in messages) {
                const userMsgs = messages[userId];
                if (userMsgs && userMsgs.length > 0) {
                    const lastMsg = userMsgs[userMsgs.length-1];
                    let userName = 'Anonymous';
                    let avatar = 'A';
                    // try to extract from first message
                    if (userMsgs[0].sender === 'user' && userMsgs[0].userName) {
                        userName = userMsgs[0].userName;
                    } else {
                        // find any user message with name
                        for (let m of userMsgs) {
                            if (m.sender === 'user' && m.userName) {
                                userName = m.userName;
                                break;
                            }
                        }
                    }
                    avatar = userName.charAt(0).toUpperCase();
                    
                    const unread = userMsgs.filter(m => m.sender === 'user' && !m.read).length;
                    
                    users[userId] = {
                        id: userId,
                        name: userName,
                        avatar: avatar,
                        lastMsg: lastMsg.text,
                        lastTime: lastMsg.timestamp,
                        unread: unread
                    };
                }
            }
            updateUserCount();
        }

        function updateUserCount() {
            document.getElementById('userCount').innerText = Object.keys(users).length;
        }

        function renderUserList() {
            const container = document.getElementById('userList');
            if (Object.keys(users).length === 0) {
                container.innerHTML = '<div class="empty-state">No active conversations yet.</div>';
                return;
            }
            let html = '';
            for (let id in users) {
                const u = users[id];
                const activeClass = (currentUserId === id) ? 'active' : '';
                const unreadBadge = u.unread > 0 ? `<span class="badge">${u.unread}</span>` : '';
                html += `<div class="user-item ${activeClass}" onclick="openChat('${id}')">
                    <div class="user-avatar">${u.avatar}</div>
                    <div class="user-info">
                        <div class="user-name">
                            ${u.name}
                            <span>${formatTime(u.lastTime)}</span>
                        </div>
                        <div class="user-preview">
                            ${escapeHTML(u.lastMsg.substring(0, 30))}${u.lastMsg.length > 30 ? 'â€¦' : ''}
                            ${unreadBadge}
                        </div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function openChat(userId) {
            currentUserId = userId;
            // mark messages as read
            if (messages[userId]) {
                messages[userId].forEach(m => { if (m.sender === 'user') m.read = true; });
                saveMessages();
            }
            rebuildUsers();
            renderUserList();
            
            const chatArea = document.getElementById('chatArea');
            const user = users[userId];
            if (!user) return;
            
            let messagesHtml = '';
            const conv = messages[userId] || [];
            conv.forEach(msg => {
                const time = formatTime(msg.timestamp);
                if (msg.sender === 'user') {
                    messagesHtml += `<div class="message user">
                        <div class="message-content">${escapeHTML(msg.text)}</div>
                        <div class="message-time">${time}</div>
                    </div>`;
                } else {
                    messagesHtml += `<div class="message employee">
                        <div class="message-content">${escapeHTML(msg.text)}</div>
                        <div class="message-time">${time} Â· You</div>
                    </div>`;
                }
            });
            
            chatArea.innerHTML = `
                <div class="chat-header">
                    <h3>${user.name}</h3>
                    <p>User ID: ${userId.substring(0,8)}...</p>
                </div>
                <div class="messages-container" id="messageContainer">
                    ${messagesHtml || '<div style="color:#8c9aa8; text-align:center; padding:40px;">No messages yet. Say hello!</div>'}
                </div>
                <div class="reply-area">
                    <div class="reply-box">
                        <textarea id="replyInput" placeholder="Type your reply..." rows="1"></textarea>
                        <button class="send-btn" onclick="sendReply()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-scroll
            setTimeout(() => {
                const container = document.getElementById('messageContainer');
                if (container) container.scrollTop = container.scrollHeight;
            }, 50);
        }

        function sendReply() {
            if (!currentUserId) return;
            const input = document.getElementById('replyInput');
            const text = input.value.trim();
            if (!text) return;
            
            if (!messages[currentUserId]) messages[currentUserId] = [];
            
            messages[currentUserId].push({
                sender: 'employee',
                text: text,
                timestamp: new Date().toISOString(),
                read: true
            });
            
            saveMessages();
            input.value = '';
            // refresh open chat
            openChat(currentUserId);
        }

        // Helper functions
        function saveMessages() {
            localStorage.setItem('chat_system_messages', JSON.stringify(messages));
            rebuildUsers();
            renderUserList();
        }

        function formatTime(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHTML(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        // Listen for storage events (simulate cross-tab communication)
        window.addEventListener('storage', function(e) {
            if (e.key === 'chat_system_messages') {
                loadData();
            }
        });

        // Initial load
        loadData();

        // Simulate incoming messages every 30 seconds for demo
        // (In real app, this would be via websockets)
        setInterval(() => {
            // Just a demo: if no users, create a fake user
            if (Object.keys(users).length === 0) {
                const fakeId = 'user_' + Math.floor(Math.random()*10000);
                if (!messages[fakeId]) messages[fakeId] = [];
                messages[fakeId].push({
                    sender: 'user',
                    userName: 'Demo Visitor',
                    text: 'Hello, I need help with your service.',
                    timestamp: new Date().toISOString(),
                    read: false
                });
                saveMessages();
                loadData();
            }
        }, 15000); // every 15 sec
    </script>
</body>
</html>
