<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Waleed's AI Assistant</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        /* === STYLES (Keep all your existing styles - they are perfect) === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #app {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .doctor-avatar {
            width: 50px;
            height: 50px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
            border: 3px solid white;
        }

        .title h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .title p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8fafc;
        }

        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 15px;
        }

        .welcome-message h2 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #64748b;
        }

        .message {
            margin: 15px 0;
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: white;
            color: #1e293b;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .loading {
            background: #e2e8f0;
            color: #475569;
            font-style: italic;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 5px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #475569;
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        #input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            background: #f1f5f9;
            border-radius: 30px;
            padding: 5px 5px 5px 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .input-wrapper:focus-within {
            border-color: #1e3c72;
            background: white;
        }

        #message-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 1rem;
            outline: none;
            color: #1e293b;
        }

        #message-input::placeholder {
            color: #94a3b8;
        }

        #send-button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 30px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }

        #send-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #error-display {
            margin: 10px 30px 0;
            padding: 12px 20px;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 10px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .footer {
            padding: 10px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #64748b;
            font-size: 0.85rem;
        }

        .powered-by {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .powered-by span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .suggestion-chips {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .chip {
            background: #f1f5f9;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #1e3c72;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }

        .chip:hover {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .admin-badge {
            background: #ffd700;
            color: #1e3c72;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            #app { height: 95vh; }
            header { flex-direction: column; gap: 10px; }
            .message { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="header-content">
                <div class="doctor-avatar">DW</div>
                <div class="title">
                    <h1>Dr. Waleed's AI Assistant</h1>
                    <p>Your Intelligent General Assistant</p>
                </div>
            </div>
            <div class="status">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Initializing...</span>
            </div>
        </header>

        <div id="chat-container">
            <div class="welcome-message">
                <h2>üëã Welcome to Dr. Waleed's AI Assistant</h2>
                <p>Ask me ANYTHING! I can help with:</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">
                    üíä Health & Medical | üíª Technology | üìö Education | üé® Arts & Culture |
                    üåç General Knowledge | üç≥ Recipes | ‚úàÔ∏è Travel | üíº Business | üéÆ Entertainment | üî¨ Science
                </p>
            </div>
        </div>

        <div id="error-display"></div>

        <div id="input-area">
            <div class="input-wrapper">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Ask me anything about any topic..."
                    autocomplete="off"
                >
                <button id="send-button">
                    <span>Send</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>

            <div class="suggestion-chips">
                <div class="chip" onclick="useSuggestion('What is artificial intelligence?')">ü§ñ What is AI?</div>
                <div class="chip" onclick="useSuggestion('Tell me a joke')">üòÑ Tell me a joke</div>
                <div class="chip" onclick="useSuggestion('How to learn programming?')">üíª Learn coding</div>
                <div class="chip" onclick="useSuggestion('What is the capital of France?')">üóº Capital of France</div>
                <div class="chip" onclick="useSuggestion('Explain quantum physics')">‚öõÔ∏è Quantum physics</div>
                <div class="chip" onclick="useSuggestion('Healthy breakfast ideas')">ü•ó Healthy breakfast</div>
                <div class="chip" onclick="useSuggestion('Write a poem about love')">üìù Love poem</div>
                <div class="chip" onclick="useSuggestion('How to make pizza?')">üçï Pizza recipe</div>
            </div>
        </div>

        <div class="footer">
            <div class="powered-by">
                <span>‚ö° Powered by DeepSeek + OpenRouter</span>
                <span>üîí Secure Firebase</span>
            </div>
            <div class="admin-badge">Dr. Waleed's Assistant</div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAE8wf24HXrfmpMluaFOv1OHPrf_YFfqTQ",
            authDomain: "whaai-c388e.firebaseapp.com",
            projectId: "whaai-c388e",
            storageBucket: "whaai-c388e.firebasestorage.app",
            messagingSenderId: "640598205524",
            appId: "1:640598205524:web:c975f5e8b371b1043e39c1",
            measurementId: "G-1MHE0JBZJR"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const errorDisplay = document.getElementById('error-display');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        // Session ID
        const sessionId = 'session_' + Date.now();

        // ============================================
        // YOUR NEW OPENROUTER API KEY
        // ============================================
        const OPENROUTER_API_KEY = "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";

        // Conversation history
        let conversationHistory = [];

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function updateStatus(connected, message) {
            if (connected) {
                statusDot.className = 'status-dot';
                statusText.textContent = message || 'AI Ready';
            } else {
                statusDot.className = 'status-dot error';
                statusText.textContent = message || 'Connection Error';
            }
        }

        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 5000);
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = getCurrentTime();
            messageDiv.appendChild(timeDiv);

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Save to conversation history
            if (type === 'user' || type === 'ai') {
                conversationHistory.push({
                    role: type === 'user' ? 'user' : 'assistant',
                    content: content
                });
                if (conversationHistory.length > 10) conversationHistory = conversationHistory.slice(-10);
            }

            // Save to Firestore
            if (type === 'user' || type === 'ai') {
                db.collection('chats').add({
                    content: content,
                    type: type,
                    sessionId: sessionId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent
                }).catch(err => console.log('Firestore save error:', err));
            }
        }

        function addLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading';
            loadingDiv.id = 'loading-message';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';

            const textDiv = document.createElement('div');
            textDiv.textContent = 'Thinking';

            loadingDiv.appendChild(typingIndicator);
            loadingDiv.appendChild(textDiv);
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
        }

        // ============================================
        // OPENROUTER API CALL - FIXED USING OFFICIAL STRUCTURE
        // ============================================
        async function callDeepSeek(userMessage) {
            // Following the OpenAI SDK pattern from the official docs
            const requestBody = {
                model: 'deepseek/deepseek-chat-v3-0324:free',
                messages: [
                    {
                        role: 'system',
                        content: 'You are Dr. Waleed\'s helpful AI assistant. You provide accurate, detailed, and helpful answers about ANY topic including health, technology, science, history, entertainment, cooking, travel, business, education, and general knowledge. Be friendly, thorough, and always give complete responses.'
                    },
                    ...conversationHistory.filter(msg => msg.role !== 'system'),
                    {
                        role: 'user',
                        content: userMessage
                    }
                ],
                temperature: 0.7,
                max_tokens: 2000,
                top_p: 0.9,
                stream: false
            };

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        // Adding the optional headers as shown in the docs
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Dr. Waleed AI'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('API Error Response:', errorData);
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('Invalid response format');
                }

            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }

        // ============================================
        // MAIN SEND MESSAGE FUNCTION
        // ============================================
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            messageInput.value = '';
            addMessage(message, 'user');

            sendButton.disabled = true;
            messageInput.disabled = true;
            addLoadingMessage();

            try {
                const aiResponse = await callDeepSeek(message);
                removeLoadingMessage();
                addMessage(aiResponse, 'ai');
                updateStatus(true, 'AI Ready');

            } catch (error) {
                removeLoadingMessage();

                let errorMessage = 'I apologize, but I encountered an error. ';

                if (error.message.includes('502')) {
                    errorMessage += 'The service is temporarily unavailable. Please try again in a moment.';
                } else if (error.message.includes('401')) {
                    errorMessage += 'API key issue. Please check your configuration.';
                } else {
                    errorMessage += 'Please try again.';
                }

                addMessage(errorMessage, 'ai');
                showError(error.message);
                updateStatus(false, 'Error');

            } finally {
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // ============================================
        // SUGGESTION CHIPS
        // ============================================
        window.useSuggestion = function(suggestion) {
            messageInput.value = suggestion;
            sendMessage();
        };

        // ============================================
        // TEST API CONNECTION
        // ============================================
        async function testConnection() {
            updateStatus(false, 'Testing...');
            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Dr. Waleed AI'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat-v3-0324:free',
                        messages: [{ role: 'user', content: 'Say "OK" if you can hear me' }],
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    updateStatus(true, 'AI Ready');
                    setTimeout(() => {
                        addMessage('Hello! I am Dr. Waleed\'s AI assistant. I can help you with ANY topic - health, technology, science, history, entertainment, and more! What would you like to know today?', 'ai');
                    }, 500);
                } else {
                    const errorText = await response.text();
                    console.error('Connection test failed:', response.status, errorText);
                    updateStatus(false, 'Connection Failed');
                    setTimeout(() => {
                        addMessage(`‚ö†Ô∏è Having trouble connecting to the AI service. Error: ${response.status}`, 'ai');
                    }, 500);
                }
            } catch (error) {
                console.error('Connection test error:', error);
                updateStatus(false, 'Connection Error');
                setTimeout(() => {
                    addMessage('‚ö†Ô∏è Unable to connect to the AI service. Please check your internet connection.', 'ai');
                }, 500);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        testConnection();

        console.log('‚úÖ Dr. Waleed\'s AI Assistant - Rebuilt with correct API structure');
        console.log('üì° Firebase Project:', firebaseConfig.projectId);
        console.log('üîë API Key configured:', OPENROUTER_API_KEY.substring(0, 15) + '...');
    </script>
</body>
</html>
